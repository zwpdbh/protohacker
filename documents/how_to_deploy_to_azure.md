# How to deploy to Azure 

Given a standard elixir project generated by `mix new protohacker --sup`, 
how to deploy it in Azure AKS cluster.

Settings 
- resource group name is `protohacker`
- aks cluster name is `protohacker-aks`
- Application will run on port `3001`

## 1. Update `mix.exs` to include release config 

```elixir 
defmodule Protohacker.MixProject do
  use Mix.Project

  def project do
    [
      app: :protohacker,
      version: "0.1.0",
      elixir: "~> 1.14",
      start_permanent: Mix.env() == :prod,
      deps: deps(),
      releases: releases()  # Add this
    ]
  end

  defp releases do
    [
      protohacker: [
        include_executables_for: [:unix],
        applications: [runtime_tools: :permanent]
      ]
    ]
  end

  # ...
end
```

## 2. Create Dockerfile 

```yaml 
# Stage 1: Build the release
FROM elixir:1.18-slim as builder

# Install build tools
RUN apt-get update && apt-get install -y build-essential git

# Set working directory
WORKDIR /app

# Fetch dependencies
COPY mix.exs mix.lock ./
RUN mix local.hex --force && mix local.rebar --force
RUN mix deps.get

# Compile
RUN mix deps.compile

# Copy and compile app
COPY . .
RUN mix compile

# Build release
RUN mix release

# Stage 2: Runtime image
FROM ubuntu:22.04

RUN apt-get update && apt-get install -y libssl3 && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy the release from builder
COPY --from=builder /app/_build/prod/rel/protohacker .

# Ensure correct permissions
RUN chown -R 1000:1000 /app && chmod +x bin/protohacker

# Switch to non-root user
USER 1000

# Expose port (if your app listens on one)
EXPOSE 3001

# Start the app
CMD ["bin/protohacker", "start"]
```

## 3. Build and push docker image to Azure Container Registry (ACR)

```sh 
# create ACR
az acr create \
  --resource-group protohacker \
  --name protohackeracr \
  --sku Basic \
  --admin-enabled true

# login ACR 
az acr login --name protohackeracr

# get the login server 
ACR_LOGIN_SERVER=$(az acr show --name protohackeracr --query loginServer --output tsv)

# Tag and push the image:
docker build -t protohacker:latest .
docker tag protohacker:latest $ACR_LOGIN_SERVER/protohacker:v1
docker push $ACR_LOGIN_SERVER/protohacker:v1
```

## 4. Connect kubectl to AKS Cluster

```sh 
az aks get-credentials \
  --resource-group protohacker \
  --name protohacker-aks

# verify 
kubectl cluster-info
kubectl get nodes  
```

## 5. Deploy to AKS with Kubernetes Manifest

```yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: protohacker
  labels:
    app: protohacker
spec:
  replicas: 2
  selector:
    matchLabels:
      app: protohacker
  template:
    metadata:
      labels:
        app: protohacker
    spec:
      containers:
      - name: protohacker
        image: protohackeracr.azurecr.io/protohacker:v1
        ports:
        - containerPort: 3001
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      imagePullSecrets:
      - name: acr-secret  # You'll create this next
---
apiVersion: v1
kind: Service
metadata:
  name: protohacker-service
spec:
  type: LoadBalancer
  selector:
    app: protohacker
  ports:
    - protocol: TCP
      port: 3000
      targetPort: 3001
```

## 6. (optional) Create Image Pull Secret for ACR

```sh 
az acr credential show --name protohackeracr --query "passwords[0].value" -o tsv
kubectl create secret docker-registry acr-secret \
  --docker-server=protohackeracr.azurecr.io \
  --docker-username=protohackeracr \
  --docker-password=<ACR_PASSWORD> \
  --docker-email=not@used.com
```

## 7. Apply the Deployment

```sh 
kubectl apply -f k8s/deployment.yaml
```

## 8. Check Deployment Status

```sh 
kubectl get pods
kubectl get services

# Wait until the service gets an external IP:
kubectl get service protohacker-service
```

## 9. (Optional) Clean Up

```sh
kubectl delete -f k8s/deployment.yaml
kubectl delete secret acr-secret 
```